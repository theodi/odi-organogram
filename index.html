<!DOCTYPE html>
<meta charset="utf-8">
<title>ODI Organogram</title>
<style>

body {
  font-family: "Helvetica Neue" "Helvetica" sans-serif;
}

table td {
  padding: 10px;
  color: white;
}

.node circle, circle.node {
  fill: #fff;
  stroke: #2254F4;
  stroke-width: 1.5px;
}

.node.hiring circle, circle.node.hiring {
  stroke: #FF6700;
}

circle.programme {
  stroke: black;
  fill: black;
}

.node {
  font-size: 10px;
}

.node.hiring {
  color: #333333;
}

.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}

#chord text {
  font-size: 10px;
}

path.fade {
  opacity: 0.05;
}

</style>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

<script src="http://code.jquery.com/jquery-2.1.4.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<body>
  <div class="container">
    <h1 class="page-header">ODI Organograms</h1>
    <p>The following diagrams summarise the data found in the <a href="https://docs.google.com/spreadsheets/d/1AfRjtGOeX9h_6k2HaWs6PvEe53INPO6EHtOdfjbTZZ4/edit">2015 ODI Organogram spreadsheet</a>. Note that this is <strong>not</strong> currently automatically updated based on the data.</p>
    <table style="width: 100%">
      <tr></tr>
    </table>
    <h2>Line Management</h2>
    <p>The following visualisation shows our line management hierarchy, including new roles but not new line management that may result from those roles being filled. Hover over a name to see the role title for that person.</p>
    <svg id="line-management"></svg>
    <h2>Programmes and Functions</h2>
    <p>The following visualisation shows people's relationships to different programmes and functions. Hover over a programme, function, or person, to see who does what.</p>
    <svg id="chord"></svg>
    <h2>Programmes</h2>
    <p>The following visualisation shows people's relationships to different programmes (the dots with black borders). Hover over a dot to see the name of the programme, person or unfilled role. Drag to adjust the layout.</p>
    <svg id="programmes"></svg>
    <h2>Functions</h2>
    <p>The following visualisation shows people's relationships to different functions (the grey dots with black borders). Hover over a dot to see the name of the function, person or unfilled role. Drag to adjust the layout.</p>
    <svg id="functions"></svg>
  </div>

<script src="http://d3js.org/d3.v3.min.js"></script>
<script type="text/csv" id="people">Member Id,First Name,Last Name,In Post,Gender,Reference Name,Role Title,Role Type,# Reports,Reports To ID,Reports To,Membership (11),Learning (12),Franchise (5),Services (23),Evidence (21),Labs (27),Strategy (7),Environment (14),Culture (18),per programme,leadership (11),finance (4),sales (10),marketing (2),engagement (5),account mgmt (6),project mgmt (10),consultancy (9),research (16),training (4),product mgmt (7),software (13),communications (2),production (5),events (3),team support (16),people dev (3)
1,NK,NK,FALSE,NK,Account Manager,Account Manager,Permanent,0,70,Richard Stirling,,,,X,,,,,,100%,,,,,,X,,,,,,,,,,,
2,Adam,Hinchliff,TRUE,male,Adam Hinchliff,Research Project Manager,Fixed-term,0,82,Tom Heath,,,,,X,X,,,,50%,,,,,,,X,,,,,,,,,,
3,Adam,Sven Johnson,TRUE,male,Adam Sven Johnson,Developer,Permanent,0,38,James Smith,,,,,,X,,,,100%,,,,,,,,,,,,X,,,,,
4,Adrian,Philpott,TRUE,male,Adrian Philpott,Brand Design,Associate,0,49,Laura Davis,,,,,,X,,,X,50%,,,,,,,,,,,,,,X,,,
5,Alison,Walters,TRUE,female,Alison Walters,Finance,Permanent,1,54,Louise Burke,,,,X,X,X,,X,,25%,,X,,,,,,,,,,,,,,,
6,Amanda,Smith,TRUE,female,Amanda Smith,Community Engagement Manager,Permanent,0,82,Tom Heath,,,,,X,X,,,,50%,,,,,X,,,,,,,,,,,,
7,Andrea,Cox,TRUE,female,Andrea Cox,Membership Manager,Permanent,1,66,Rachel Leech,X,,,,,,,,,100%,,,,,X,X,,,,,,,,,,,
8,Anna,Scott,TRUE,female,Anna Scott,Writer / Editor,Permanent,0,49,Laura Davis,,,,X,X,,,,X,33%,,,,,,,,,,,,,,X,,,
9,Anneza,Pitsialis,TRUE,female,Anneza Pitsialis,Programme Administrator,Permanent,0,30,Emma Truswell,,,X,,,,,,,100%,,,,,,X,,,,,,,,,,,
10,Ben,Couston,TRUE,male,Ben Couston,Labs Intern,Fixed-term,0,38,James Smith,,,,,,X,,,,100%,,,,,,,,,X,,,X,,,,,
11,Benjamin,Cave,TRUE,male,Benjamin Cave,Trainer,Permanent,0,74,Simon Bullmore,,X,,,,,,,,100%,,,,,,,,,,X,,,,,,,
12,Bethany,Bloomer,TRUE,female,Bethany Bloomer,Business Support Administrator,Fixed-term,0,46,Kateryna Onyiliogwu,,,,,,X,,X,,50%,,,,,,,,,,,,,,,,X,
13,Bethany,Cooper,TRUE,female,Bethany Cooper,Business Support Administrator,Fixed-term,0,46,Kateryna Onyiliogwu,,,,X,,,,X,,50%,,,,,,,,,,,,,,,,X,
14,Brendon,Harvey,TRUE,male,Brendon Harvey,Services Intern,Fixed-term,0,30,Emma Truswell,,,,X,,,,,,100%,,,,,,,,,X,,,,,,,,
15,Briony,Phillips,TRUE,female,Briony Phillips,ODCS Programme Lead,Fixed-term,0,41,Jeni Tennison,,,,X,,,,,,100%,,,,,X,,,,,,X,,,,,,
16,NK,NK,TRUE,NK,Business Support Administrator,Business Support Administrator,Permanent,0,46,Kateryna Onyiliogwu,,,,,,,,X,,100%,,,,,,,,,,,,,,,,X,
17,Carl,Rodrigues,TRUE,male,Carl Rodrigues,Commercial Sales,Associate,0,32,Gavin Starks,X,,,,,,,,,100%,,,X,,,,,,,,,,,,,,
18,Carlina,George,TRUE,female,Carlina George,People,Permanent,0,75,Simone Giles,,,,,,,,X,,100%,,,,,,,,,,,,,,,,,X
19,Clara,Lewis,TRUE,female,Clara Lewis,Programme Support,Permanent,0,7,Andrea Cox,X,,,,,,,,,100%,,,,,,,,,,,,,,,,X,
20,Daniel,Gavrilov,TRUE,male,Daniel Gavrilov,Labs Intern,Fixed-term,0,38,James Smith,,,,,,X,,,,100%,,,,,,,,,X,,,X,,,,,
21,Dave,Tarrant,TRUE,male,Dave Tarrant,Senior Trainer,Permanent,0,74,Simon Bullmore,,X,,,,,,,,100%,,,,,,,,,,X,,,,,,,
22,Dawn,Duhaney,TRUE,female,Dawn Duhaney,Junior Analyst,Permanent,0,30,Emma Truswell,,,,X,,,,,,100%,,,,,,,,,X,,,,,,,,
23,NK,NK,FALSE,NK,Developer for ODCs,Developer for ODCs,Fixed-term,0,38,James Smith,,,,,,X,,,,100%,,,,,,,,,,,,X,,,,,
24,NK,NK,FALSE,NK,Digital Marketing Manager,Digital Marketing Manager,Fixed-term,0,66,Rachel Leech,X,X,,X,X,X,,,X,17%,,,,X,,,,,,,,,,,,,
25,Ellen,Broad,TRUE,female,Ellen Broad,Policy Advisor,Permanent,1,41,Jeni Tennison,,,,X,X,,X,,,33%,,,,,,,,X,,X,,,,,,,
26,Emeafa,Doe,TRUE,female,Emeafa Doe,Programme Support,Permanent,0,37,Jade Croucher,,,X,,X,,,,,50%,,,,,,,,,,,,,,,,X,
27,Emily,Vacher,TRUE,female,Emily Vacher,Learning Intern,Fixed-term,0,74,Simon Bullmore,,X,,,,,,,,100%,,,,,,,,,,,,,,,,X,
28,Emma,Galal,TRUE,female,Emma Galal,Executive Support,Permanent,0,37,Jade Croucher,,,,,,,,X,,100%,,,,,,,,,,,,,,,,X,
29,Emma,Thwaites,TRUE,female,Emma Thwaites,Communications,Associate,1,32,Gavin Starks,,,,,X,,X,,X,33%,X,,,,,,,,,,,,X,,,,
30,Emma,Truswell,TRUE,female,Emma Truswell,Deputy Head of Services,Permanent,5,70,Richard Stirling,,,,X,,,,,,100%,,,,,,X,X,X,,,,,,,,,
31,Fiona,Smith,TRUE,female,Fiona Smith,Researcher (OD4D),Fixed-term,0,53,Liz Carolan,,,,X,,,,,,100%,,,,,,,,,X,,,,,,,,
32,Gavin,Starks,TRUE,male,Gavin Starks,CEO,Permanent,9,,,X,X,X,,,,X,,X,20%,X,,X,,,,,,,,X,,,,,,
33,Hannah,Redler,TRUE,female,Hannah Redler,Art Programme,Associate,0,49,Laura Davis,,,,,,,,,X,100%,,,,,,,X,,,,,,,,,,
34,Iraia,Monteagudo,TRUE,female,Iraia Monteagudo,Startup Programme Assistant,Fixed-term,0,84,Ulrich Atz,,,,X,,,,,,100%,,,,,,X,,,,,,,,,,X,
35,Irina,Bolychevsky,TRUE,female,Irina Bolychevsky,Open Data Certificate Community Builder,Fixed-term,0,81,Sumika Sakanishi,,,,,,X,,,,100%,,,,,X,,,,,,X,,,,,,
36,Jack,Hardinges,TRUE,male,Jack Hardinges,Research Assistant,Fixed-term,0,82,Tom Heath,,,,,X,,,,,100%,,,,,,,,,X,,,,,,,,
37,Jade,Croucher,TRUE,female,Jade Croucher,Operations Manager,Permanent,4,32,Gavin Starks,,,,,,,,X,,100%,X,,,,,,,,,,,,,,,X,
38,James,Smith,TRUE,male,James Smith,Head of Labs,Permanent,8,41,Jeni Tennison,X,,,,,X,,,X,33%,X,,,,,,,,,,,X,,,,,
39,Jamie,Fawcett,TRUE,male,Jamie Fawcett,Research Assistant,Fixed-term,0,82,Tom Heath,,,,,X,,,,,100%,,,,,,,,,X,,,,,,,,
40,Jaz,Donovan,TRUE,female,Jaz Donovan,Summit Sales,Fixed-term,0,48,Keren Bowman,,,,,,,,,X,100%,,,X,,,,,,,,,,,,,,
41,Jeni,Tennison,TRUE,female,Jeni Tennison,Deputy CEO & Technical Director,Permanent,8,32,Gavin Starks,,,,X,X,X,X,,,25%,X,,,,,,,X,,,,X,,,,,
42,Joe,Packman,TRUE,male,Joe Packman,Digital Producer,Permanent,0,49,Laura Davis,,,,,,,,,X,100%,,,,,,,,,,,,,,X,,,
43,Jordan,Elver,FALSE,male,Jordan Elver,Developer for Membership,Fixed-term,0,38,James Smith,X,,,,,,,,,100%,,,,,,,,,,,,X,,,,,
44,Julie,Freeman,TRUE,female,Julie Freeman,Art Programme,Associate,0,49,Laura Davis,,,,,,,,,X,100%,,,,,,,X,,,,,,,,,,
45,NK,NK,FALSE,NK,Junior Developer,Junior Developer,Permanent,0,38,James Smith,,,,,,X,,,,100%,,,,,,,,,,,,X,,,,,
46,Kateryna,Onyiliogwu,TRUE,female,Kateryna Onyiliogwu,Operations Team Leader,Temp,4,37,Jade Croucher,,,,,X,,,X,,50%,,,,,,,,,,,,,,,,X,
47,Kathryn,Pritchard,TRUE,female,Kathryn Pritchard,Services Intern,Fixed-term,0,30,Emma Truswell,,,,X,,,,,,100%,,,,,,,,,X,,,,,,,,
48,Keren,Bowman,TRUE,female,Keren Bowman,Events Coordinator,Permanent,3,49,Laura Davis,,,,,,,,,X,100%,,,,,,,,,,,,,,,X,,
49,Laura,Davis,TRUE,female,Laura Davis,Head of Content,Permanent,7,32,Gavin Starks,,,,,,,,,X,100%,X,,,X,,,,,,,,,,X,X,,
50,Leigh,Dodds,TRUE,male,Leigh Dodds,Senior Technical Consultant,Permanent,1,70,Richard Stirling,,X,,X,,X,,,,33%,,,,,,,,X,X,X,X,X,,,,,
51,Leonard,Mack,TRUE,male,Leonard Mack,Research Bid Writer,Fixed-term,0,82,Tom Heath,,,,,X,X,,,,50%,,,X,,,,,,X,,,,,,,,
52,Lewis,Kille,TRUE,male,Lewis Kille,Business Support Administrator,Fixed-term,0,46,Kateryna Onyiliogwu,,,,,,,,X,,100%,,,,,,,,,,,,,,,,X,
53,Liz,Carolan,TRUE,female,Liz Carolan,International Development Manager,Fixed-term,1,50,Leigh Dodds,,,,X,,,,,,100%,,,X,,,,,X,,,,,,,,,
54,Louise,Burke,TRUE,female,Louise Burke,Finance & Compliance Director,Permanent,3,32,Gavin Starks,,,,,,,X,X,X,33%,X,X,,,,,,,,,,,,,,,
55,Mandy,Costello,TRUE,female,Mandy Costello,Training Projects and Delivery Manager,Permanent,1,74,Simon Bullmore,,X,,,,,,,,100%,,,,,,,X,,,,,,,,,,
56,Maria,Demetriou,TRUE,female,Maria Demetriou,Finance Support,Fixed-term,0,5,Alison Walters,,,,,,,,X,,100%,,X,,,,,,,,,,,,,,X,
57,Michelle,Prescott,TRUE,female,Michelle Prescott,People,Associate,0,75,Simone Giles,,,,,,,,X,,100%,,,,,,,,,,,,,,,,,X
58,Orsola,DeMarco,TRUE,female,Orsola DeMarco,Startup Programme Assistant,Permanent,0,84,Ulrich Atz,,,,X,,,,,,100%,,,,,,X,,,,,,,,,,X,
59,Patrice,John-Baptiste,TRUE,female,Patrice John-Baptiste,Communications,Fixed-term,0,29,Emma Thwaites,,,,,X,,,,X,50%,,,,,,,,,,,,,X,,,,
60,Patrik,Wagner,TRUE,male,Patrik Wagner,Commercial Sales,Associate,0,66,Rachel Leech,X,,,,,,,,,100%,,,X,,,,,,,,,,,,,,
61,Peter,Wells,TRUE,male,Peter Wells,Policy Advisor,Fixed-term,0,25,Ellen Broad,,,,,,,X,,,100%,,,,,,,,X,,,,,,,,,
62,NK,NK,FALSE,NK,PhD Student,PhD Student,Fixed-term,0,82,Tom Heath,,,,,,X,,,,100%,,,,,,,,,X,,,,,,,,
63,NK,NK,FALSE,NK,PhD Student,PhD Student,Fixed-term,0,82,Tom Heath,,,,,,X,,,,100%,,,,,,,,,X,,,,,,,,
64,Phil,Lang,TRUE,male,Phil Lang,Digital Production Editor,Permanent,0,49,Laura Davis,,,,X,X,,,,X,33%,,,,,,,,,,,,,,X,,,
65,NK,NK,TRUE,NK,Programme Support,Programme Support,Permanent,0,37,Jade Croucher,,,,,X,X,,,,50%,,,,,,,,,,,,,,,,X,
66,Rachel,Leech,TRUE,female,Rachel Leech,Membership Business Manager,Permanent,3,32,Gavin Starks,X,,,,,,,,,100%,X,,X,,,,,,,,X,,,,,,
67,Remi,Van,TRUE,female,Remi Van,Events Support,Fixed-term,0,48,Keren Bowman,,,,,,,,,X,100%,,,,,,,,,,,,,,,X,X,
68,NK,NK,FALSE,NK,Research Impact Lead,Research Impact Lead,Permanent,0,82,Tom Heath,,,,,X,,,,,100%,,,,,,,,,X,,,,,,,,
69,Richard,Norris,TRUE,male,Richard Norris,Innovation Unit Project Manager,Permanent,0,41,Jeni Tennison,,,,X,X,X,,,,33%,,,,,,,X,X,,,,,,,,,
70,Richard,Stirling,TRUE,male,Richard Stirling,International Director,Permanent,5,32,Gavin Starks,,,X,X,,,X,,,33%,X,,X,,,,,X,,,,,,,,,
71,Sam,Haines,TRUE,female,Sam Haines,Training Projects and Delivery Manager,Permanent,0,74,Simon Bullmore,,X,,,,,,,,100%,,,,,,,X,,,,,,,,,,
72,Sam,Michel,TRUE,male,Sam Michel,Summit Programme Delivery,Associate,0,48,Keren Bowman,,,,,,,,,X,100%,,,,,,,X,,,,,,,,,,
73,Sam,Pikesley,TRUE,male,Sam Pikesley,Head of Robots,Permanent,0,41,Jeni Tennison,,,,,,X,,,,100%,,,,,,,,,,,,X,,,,,
74,Simon,Bullmore,TRUE,male,Simon Bullmore,Business Manager (Training),Permanent,5,32,Gavin Starks,,X,,,,,,,,100%,X,,X,,,,,,,,,,,,,,
75,Simone,Giles,TRUE,female,Simone Giles,PeopleDev,Permanent,2,54,Louise Burke,,,,,,,,X,,100%,,,,,,,,,,,,,,,,,X
76,Stefan,Janusz,TRUE,male,Stefan Janusz,Open Data Story Producer,Fixed-term,0,82,Tom Heath,,,,,X,,,,,100%,,,,,,,X,,X,,,,,,,,
77,Steff,Warwick,TRUE,female,Steff Warwick,Training Coordinator,Permanent,0,55,Mandy Costello,,X,,,,,,,,100%,,,,,,,,,,,,,,,,X,
78,Stephanie,Dunstan,TRUE,female,Stephanie Dunstan,Accounts Assistant,Permanent,0,54,Louise Burke,X,X,X,,,,,X,,25%,,X,,,,,,,,,,,,,,,
79,Stephen,Fortune,TRUE,male,Stephen Fortune,Labs Intern,Fixed-term,0,38,James Smith,,,,,,X,,,,100%,,,,,,,,,X,,,X,,,,,
80,Stuart,Harrison,TRUE,male,Stuart Harrison,Developer,Permanent,0,41,Jeni Tennison,X,,,,,X,,,X,33%,,,,,,,,,,,,X,,,,,
81,Sumika,Sakanishi,TRUE,female,Sumika Sakanishi,Product Manager,Permanent,1,41,Jeni Tennison,,,,,,X,,,,100%,,,,,,,,,,,X,,,,,,
82,Tom,Heath,TRUE,male,Tom Heath,Head of Research,Permanent,9,41,Jeni Tennison,,,,,X,X,,,,50%,X,,,,,,,,X,,,,,,,,
83,Tom,Tharakan,TRUE,male,Tom Tharakan,Bid Manager,Permanent,0,70,Richard Stirling,,X,,X,X,X,,,,25%,,,X,,,,,,,,,,,,,,
84,Ulrich,Atz,TRUE,male,Ulrich Atz,Startup Programme Manager,Permanent,2,70,Richard Stirling,,,,X,,,,,,100%,,,,,X,,,,,,X,,,,,,
85,NK,NK,FALSE,NK,UX Designer,UX Designer,Fixed-term,0,38,James Smith,,,,,,X,,,,100%,,,,,,,,,,,,X,,,,,
86,William,Gerry,TRUE,male,William Gerry,Junior Consultant,Fixed-term,0,30,Emma Truswell,,,,X,,,,,,100%,,,,,,,X,X,,,,,,,,,</script>
<script>

var programmes = ["Membership", "Learning", "Franchise", "Services", "Evidence", "Labs", "Strategy", "Environment", "Culture"];
var functions = ["leadership", "finance", "sales", "marketing", "engagement", "account mgmt", "project mgmt", "consultancy", "research", "training", "product mgmt", "software", "communications", "production", "events", "team support", "people dev"];

var diameter = 960,
    radius = diameter / 2,
    innerRadius = radius / 2;

var width = 960,
    height = 500;

var nodeRadius = 8;

var cluster = d3.layout.cluster()
    .size([360, radius - 120]);

var tree = d3.layout.tree()
    .size([360, diameter / 2 - 120])
    .separation(function(a, b) { return (a.parent == b.parent ? 1 : 2) / a.depth; });

var diagonal = d3.svg.diagonal.radial()
    .projection(function(d) { return [d.y, d.x / 180 * Math.PI]; });

var color = d3.scale.ordinal()
    .domain(programmes)
    .range(["#0DBC37", "#1DD3A7", "#08DEF9", "#722EA5", "#B13198", "#EF3AAB", "#D60303", "#FF6700", "#F9BC26"]);

var arc = d3.svg.arc()
    .outerRadius(nodeRadius)
    .innerRadius(function (d) { return (d.data.type !== "person" || d.data.inPost) ? 0 : 5 });

var pie = d3.layout.pie()
    .sort(null)
    .value(function(d) { return d.size; });

var chord = d3.layout.chord()
    .padding(.04)
    .sortSubgroups(d3.ascending)
    .sortChords(d3.ascending);

var chordArc = d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(innerRadius + 20);

var svg = d3.select("#line-management")
    .attr("width", radius * 2)
    .attr("height", radius * 2)
  .append("g")
    .attr("transform", "translate(" + radius + "," + radius + ")");

var svg2 = d3.select("#programmes")
    .attr("width", width)
    .attr("height", height);

var svg3 = d3.select("#functions")
    .attr("width", width)
    .attr("height", height);

var svg4 = d3.select("#chord")
    .attr("width", radius * 2)
    .attr("height", radius * 2)
  .append("g")
    .attr("transform", "translate(" + radius + "," + radius + ")");

d3.select("tr").selectAll("td")
    .data(programmes)
  .enter().append("td")
    .attr("style", function (d) { return "background: " + color(d) + "; width: 11%"; })
    .text(function(d) { return d; });


var peopleLookup = {};
var parentLookup = {};
var matrix = [];
var peopleRootId;

var nameByIndex = d3.map();
var typeByIndex = d3.map();
var indexByName = d3.map();
var n = 0;

var programmeRegex = new RegExp(programmes.join('|'));
var functionRegex = new RegExp(functions.join('|'));

var programmeLookup = {};
for (p in programmes) {
  nameByIndex.set(n, programmes[p]);
  typeByIndex.set(n, "programme");
  indexByName.set(programmes[p], n);
  matrix[n] = [];
  n++;
  programmeLookup[programmes[p]] = [];
}
var functionLookup = {};
for (f in functions) {
  nameByIndex.set(n, functions[f]);
  typeByIndex.set(n, "function");
  indexByName.set(functions[f], n);
  matrix[n] = [];
  n++;
  functionLookup[functions[f]] = [];
}

d3.csv.parse(document.getElementById('people').firstChild.nodeValue, function (d) {
  var person = {
    type: "person",
    id: +d["Member Id"],
    name: d["Reference Name"],
    inPost: d["In Post"] == "TRUE",
    roleTitle: d["Role Title"],
    parent: +d["Reports To ID"],
    programmes: [],
    functions: []
  };
  var m;
  nameByIndex.set(n, person.name);
  typeByIndex.set(n, "person");
  indexByName.set(person.name, n);
  matrix[n] = [];
  n++;
  for (var col in d) {
    if (d[col] == "X") {
      if (m = col.match(programmeRegex)) {
        person.programmes.push(m[0]);
        programmeLookup[m[0]].push(person.id);
      } else if (m = col.match(functionRegex)) {
        person.functions.push(m[0]);
        functionLookup[m[0]].push(person.id);
      }
      if (m) {
        matrix[indexByName.get(m[0])][indexByName.get(person.name)] = 5;
        matrix[indexByName.get(person.name)][indexByName.get(m[0])] = 1;
      }
    }
  }
  peopleLookup[person.id] = person;
  if (parentLookup[person.parent] == undefined) {
    parentLookup[person.parent] = [];
  }
  parentLookup[person.parent].push(person.id);
  if (person.parent == 0) {
    peopleRootId = person.id;
  }
  return;
});

for (var i = 0; i < n; i++) {
  for (var j = 0; j < n; j++) {
    if (matrix[i][j] === undefined) matrix[i][j] = 0;
  }
}

var createHierarchy = function (id) {
  var 
    person = peopleLookup[id],
    p = { 
      type: "person",
      name: person.name, 
      inPost: person.inPost,
      roleTitle: person.roleTitle,
      programmes: person.programmes
    },
    children = parentLookup[id];
  if (children !== undefined) {
    p.children = [];
    for (var i = 0; i < children.length; i++) {
      p.children.push(createHierarchy(children[i]));
    }
  }
  return p;
};

var createProgrammeGraph = function () {
  var graph = {
    nodes: [],
    links: []
  };
  for (p in peopleLookup) {
    var person = peopleLookup[p];
    graph.nodes[person.id - 1] = person;
  }
  programmes.forEach(function (programme) {
    graph.nodes.push({ name: programme, type: "programme" });
    programmeLookup[programme].forEach(function (id) {
      graph.links.push({
        source: graph.nodes.length - 1,
        target: id - 1
      });
    });
  });
  return graph;
};

var createFunctionGraph = function () {
  var graph = {
    nodes: [],
    links: []
  };
  for (p in peopleLookup) {
    var person = peopleLookup[p];
    graph.nodes[person.id - 1] = person;
  }
  functions.map(function (func) {
    graph.nodes.push({ name: func, type: "function" });
    functionLookup[func].map(function (id) {
      graph.links.push({
        source: graph.nodes.length - 1,
        target: id - 1
      });
    });
  });
  return graph;
};

var drawNode = function(node) {
  node.append("circle")
    .style("stroke-width", function (d) { return d.type == "person" ? 0 : 5 })
    .style("stroke", "black")
    .style("fill", "#ffffff")
    .attr("r", nodeRadius);

  var g = node.selectAll(".arc")
      .data(function (d) { 
        if (d.programmes) {
          return pie(d.programmes.map(function (p) { return { name: p, size: 1, type: "person", inPost: d.inPost }; })); 
        } else {
          return pie([{name: d.name, size: 1, type: d.type}]);
        }
      })
    .enter().append("g")
      .attr("class", "arc");

  g.append("path")
      .attr("d", arc)
      .style("fill", function(d) { 
        if (d.data.type == "function") {
          return "#999999";
        } else {
          return color(d.data.name);
        }
      });
};

var drawLineMgmt = function (root) {
  // uncomment to get all the leaf nodes at the same level
  // var nodes = cluster.nodes(root);
  // var links = cluster.links(nodes);

  // leaf nodes at different levels
  var nodes = tree.nodes(root);
  var links = tree.links(nodes);

  var link = svg.selectAll("path.link")
      .data(links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", diagonal);

  var node = svg.selectAll("g.node")
      .data(nodes)
    .enter().append("g")
      .attr("class", function (d) { return "node"; })
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })

  drawNode(node);

  node.append("title")
      .text(function(d) { return d.roleTitle; });

  node.append("text")
      .attr("dy", ".31em")
      .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      .attr("transform", function(d) { return d.x < 180 ? "translate(10)" : "rotate(180)translate(-10)"; })
      .text(function(d) { return d.name; });

  d3.select(self.frameElement).style("height", radius * 2 + "px");
};

drawLineMgmt(createHierarchy(peopleRootId));

var drawChord = function (matrix, svg) {
  var chordColor = function(i) {
    var type = typeByIndex.get(i);
    if (type === "programme") {
      return color(nameByIndex.get(i));
    } else if (type === "function") {
      return "#666666";
    } else {
      return "#AAAAAA";
    }
  };

  chord.matrix(matrix);

  var g = svg.selectAll(".group")
      .data(chord.groups)
    .enter().append("g")
      .attr("class", "group")
      .on("mouseover", mouseover);

  g.append("path")
      .style("fill", function(d) { return chordColor(d.index); })
      .style("stroke", function(d) { return chordColor(d.index); })
      .attr("d", chordArc);

  g.append("text")
      .each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
      .attr("dy", ".35em")
      .attr("transform", function(d) {
        return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
            + "translate(" + (innerRadius + 26) + ")"
            + (d.angle > Math.PI ? "rotate(180)" : "");
      })
      .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
      .text(function(d) { return nameByIndex.get(d.index); });

  var chords = svg.selectAll(".chord")
      .data(chord.chords)
    .enter().append("path")
      .attr("class", "chord")
      .style("stroke", function(d) { return "none" ; })
      .style("fill", function(d) { return chordColor(d.source.index); })
      .attr("d", d3.svg.chord().radius(innerRadius));

  d3.select(self.frameElement)
    .style("height", radius * 2 + "px");

  svg
    .on("click", showAll);

  function mouseover(d, i) {
    chords.classed("fade", function(p) {
      return p.source.index != i
          && p.target.index != i;
    });
  }

  function showAll() {
    chords.classed("fade", false);
  }
};

drawChord(matrix, svg4);

var drawGraph = function (graph, svg) {
  var nodes = graph.nodes.slice(),
      links = [],
      bilinks = [];

  var force = d3.layout.force()
      .linkDistance(10)
      .linkStrength(2)
      .size([width, height]);

  graph.links.forEach(function(link) {
    var s = nodes[link.source],
        t = nodes[link.target],
        i = {}; // intermediate node
    nodes.push(i);
    links.push({source: s, target: i}, {source: i, target: t});
    bilinks.push([s, i, t]);
  });

  force
      .nodes(nodes)
      .links(links)
      .start();

  var link = svg.selectAll(".link")
      .data(bilinks)
    .enter().append("path")
      .attr("class", "link");

  var node = svg.selectAll(".node")
      .data(graph.nodes)
    .enter().append("g")
      .attr("class", function (d) { return "node"; })
      .call(force.drag);

  drawNode(node);

  node.append("title")
      .text(function(d) { return d.name; });

  node.append("text")
      .style("font-size", "8px")
      .style("font-weight", "bold")
      .style("fill", function (d) { return d.inPost ? "white" : "#999999"; } )
      .attr("dy", ".31em")
      .attr("dx", "-.62em")
      // .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      // .attr("transform", function(d) { return d.x < 180 ? "translate(10)" : "rotate(180)translate(-10)"; })
      .text(function(d) { return (d.type == "person" && d.name !== d.roleTitle) ? d.name.match(/[A-Z]/g).join('') : ''; });

  force.on("tick", function() {
    link.attr("d", function(d) {
      return "M" + d[0].x + "," + d[0].y
          + "S" + d[1].x + "," + d[1].y
          + " " + d[2].x + "," + d[2].y;
    });
    node.attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    });
  });
};

drawGraph(createProgrammeGraph(), svg2);
drawGraph(createFunctionGraph(), svg3);

</script>
