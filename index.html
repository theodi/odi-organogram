<!DOCTYPE html>
<meta charset="utf-8">
<title>ODI Organogram</title>
<style>

body {
  font-family: "Helvetica Neue" "Helvetica" sans-serif;
}

table td {
  padding: 10px;
  color: white;
}

.node circle, circle.node {
  fill: #fff;
  stroke: #2254F4;
  stroke-width: 1.5px;
}

.node.hiring circle, circle.node.hiring {
  stroke: #FF6700;
}

circle.programme {
  stroke: black;
  fill: black;
}

.node {
  font-size: 10px;
}

.node.hiring {
  color: #333333;
}

.link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
}

#chord text {
  font-size: 10px;
}

path.fade {
  opacity: 0.05;
}

</style>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">

<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css">

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<body>
  <div class="container">
    <h1 class="page-header">ODI Organograms</h1>
    <p>The following diagrams summarise the data found in the <a href="https://docs.google.com/spreadsheets/d/1AfRjtGOeX9h_6k2HaWs6PvEe53INPO6EHtOdfjbTZZ4/edit">2015 ODI Organogram spreadsheet</a>. Note that this is <strong>not</strong> currently automatically updated based on the data.</p>
    <table style="width: 100%">
      <tr></tr>
    </table>
    <h2>Line Management</h2>
    <p>The following visualisation shows our line management hierarchy, including new roles but not new line management that may result from those roles being filled. Hover over a name to see the role title for that person.</p>
    <svg id="line-management"></svg>
    <h2>Programmes and Functions</h2>
    <p>The following visualisation shows people's relationships to different programmes and functions. Hover over a programme, function, or person, to see who does what.</p>
    <svg id="chord"></svg>
    <h2>Programmes</h2>
    <p>The following visualisation shows people's relationships to different programmes (the dots with black borders). Hover over a dot to see the name of the programme, person or unfilled role. Drag to adjust the layout.</p>
    <svg id="programmes"></svg>
    <h2>Functions</h2>
    <p>The following visualisation shows people's relationships to different functions (the grey dots with black borders). Hover over a dot to see the name of the function, person or unfilled role. Drag to adjust the layout.</p>
    <svg id="functions"></svg>
  </div>

<script src="https://d3js.org/d3.v3.min.js"></script>
<script type="text/csv" id="people">Member Id,First Name,Last Name,In Post,Gender,Name,Role Title,Timesheet Key,Timesheet,Role Type,# Reports,Reports To ID,Reports To,FTE,Main Programme,Membership,Learning,Startups,Services,Evidence,Labs,Strategy,Environment,Culture,Board,Total (%),leadership (21),finance (4),sales (11),marketing (1),engagement (8),account mgmt (3),project mgmt (11),consultancy (4),policy (4),research (5),training (2),product mgmt (2),software (8),communications (2),production (5),events (0),team support (12),people dev (3)
1,Adam,Hinchliff,TRUE,male,Adam Hinchliff,Research Project Manager,1y_0Z_ODH2Xn8DPhJINwAg2LkpbTWPvXs7uY5bov0fRA,https://docs.google.com/spreadsheets/d/1y_0Z_ODH2Xn8DPhJINwAg2LkpbTWPvXs7uY5bov0fRA/edit,Fixed-term,0,42,Louise Burke,1.0,Environment,0%,20%,20%,30%,0%,30%,0%,0%,0%,,100%,,,,,,,X,,,,,,,,,,,
2,Adam,Sven Johnson,TRUE,male,Adam Sven Johnson,Developer,,,Contract,0,30,James Smith,0.4,Labs,0%,0%,0%,0%,0%,100%,0%,0%,0%,,100%,,,,,,,,,,,,,X,,,,,
3,Adrian,Philpott,TRUE,male,Adrian Philpott,Brand Design,,,Associate,0,37,Laura Davis,0.5,Culture,0%,0%,15%,0%,0%,10%,35%,0%,40%,,100%,,,,,,,,,,,,,,,X,,,
4,Alison,Walters,TRUE,female,Alison Walters,Finance,,,Associate,0,42,Louise Burke,0.4,Environment,0%,20%,20%,30%,0%,30%,0%,0%,0%,,100%,,X,,,,,,,,,,,,,,,,
5,Amanda,Smith,TRUE,female,Amanda Smith,Account Manager,,,Permanent,0,20,Emma Truswell,1.0,Services,0%,0%,0%,100%,0%,0%,0%,0%,0%,,100%,,,,,,X,X,,,,,,,,,,,
6,Anna,Scott,TRUE,female,Anna Scott,Writer / Editor,,,Permanent,0,37,Laura Davis,1.0,Culture,10%,10%,5%,10%,15%,0%,10%,0%,40%,,100%,,,,,,,,,,,,,,,X,,,
7,Anneza,Pitsialis,TRUE,female,Anneza Pitsialis,Franchise Network Coordinator,,,Permanent,0,52,Rachel Leech,1.0,Startups,0%,0%,100%,0%,0%,0%,0%,0%,0%,,100%,,,,,X,,,,,,,,,,,,,
8,Benjamin,Cave,TRUE,male,Benjamin Cave,Trainer,,,Permanent,0,60,Simon Bullmore,1.0,Learning,0%,100%,0%,0%,0%,0%,0%,0%,0%,,100%,,,,,,,,,,,X,,,,,,,
9,Beth,Cooper,TRUE,female,Beth Cooper,Business Support Administrator,,,Fixed-term,0,29,Jade Croucher,1.0,Environment,0%,0%,0%,0%,0%,0%,0%,100%,0%,,100%,,,,,,,,,,,,,,,,,X,
10,Carl,Rodrigues,TRUE,male,Carl Rodrigues,Business Development,,,Associate,0,52,Rachel Leech,0.5,Membership,35%,20%,15%,0%,0%,20%,0%,0%,10%,,100%,,,X,,,,,,,,,,,,,,,
11,NK,NK,FALSE,NK,Commercial Network Director,Commercial Network Director,,,Permanent,0,22,Gavin Starks,1.0,Strategy,5%,5%,25%,25%,0%,10%,20%,0%,10%,,100%,X,,X,,,,,,,,,,,,,,,
12,NK,NK,FALSE,NK,Culture & Innovation Unit Programme Support,Culture & Innovation Unit Programme Support,,,Fixed-term,0,37,Laura Davis,1.0,Culture,0%,0%,0%,20%,10%,30%,0%,0%,40%,,100%,,,,,,,,,,,,,,,,,X,
13,Dave,Tarrant,TRUE,male,Dave Tarrant,Senior Trainer,,,Permanent,0,60,Simon Bullmore,1.0,Learning,0%,100%,0%,0%,0%,0%,0%,0%,0%,,100%,,,,,,,,,,,X,,,,,,,
14,Dawn,Duhaney,TRUE,female,Dawn Duhaney,Junior Project Manager,,,Permanent,0,21,Fiona Smith,1.0,Services,0%,0%,0%,100%,0%,0%,0%,0%,0%,,100%,,,,,,,X,,,,,,,,,,,
15,Ellen,Broad,TRUE,female,Ellen Broad,Policy Lead,,,Permanent,2,32,Jeni Tennison,1.0,Strategy,0%,0%,0%,0%,0%,0%,100%,0%,0%,,100%,,,,,,,,,X,,,,,,,,,
16,Emilia,Kacprzak,TRUE,female,Emilia Kacprzak,PhD Student,,,Fixed-term,0,66,Tom Heath,1.0,Labs,0%,0%,0%,0%,0%,100%,0%,0%,0%,,100%,,,,,,,,,,X,,,X,,,,,
17,Emily,Vacher,TRUE,female,Emily Vacher,Learning Support,,,Fixed-term,0,43,Mandy Costello,1.0,Learning,0%,100%,0%,0%,0%,0%,0%,0%,0%,,100%,,,,,,,,,,,,,,,,,X,
18,Emma,Galal,TRUE,female,Emma Galal,Executive Support,,,Permanent,0,29,Jade Croucher,1.0,Strategy,0%,0%,0%,0%,0%,0%,100%,0%,0%,,100%,,,,,,,,,,,,,,,,,X,
19,Emma,Thwaites,TRUE,female,Emma Thwaites,Communications,,,Associate,1,22,Gavin Starks,1.0,Strategy,10%,0%,0%,0%,20%,0%,50%,0%,20%,,100%,X,,,,,,,,,,,,,X,,,,
20,Emma,Truswell,TRUE,female,Emma Truswell,Deputy Head of Services,,,Permanent,3,55,Richard Stirling,1.0,Services,0%,0%,0%,100%,0%,0%,0%,0%,0%,,100%,X,,,,,,X,,,,,,,,,,,
21,Fiona,Smith,TRUE,female,Fiona Smith,International Development Manager,,,Fixed-term,3,55,Richard Stirling,1.0,Services,0%,0%,0%,100%,0%,0%,0%,0%,0%,,100%,,,,,,,X,,,,,,,,,,,
22,Gavin,Starks,TRUE,male,Gavin Starks,CEO,,,Permanent,9,47,Nigel Shadbolt,1.0,Strategy,0%,0%,15%,0%,0%,0%,85%,0%,0%,,100%,X,,X,,,,,,,,,,,,,,,
23,Hannah,Attwood-Foulds,TRUE,female,Hannah Attwood-Foulds,Digital Marketing Manager,,,Permanent,0,37,Laura Davis,1.0,Membership,40%,20%,0%,0%,0%,5%,0%,0%,35%,,100%,,,,X,,,,,,,,,,,,,,
24,Hannah,Redler,TRUE,female,Hannah Redler,Art Programme,,,Associate,0,37,Laura Davis,0.3,Culture,0%,0%,0%,0%,0%,0%,0%,0%,100%,,100%,,,,,,,,,,,,X,,,,,,
25,NK,NK,FALSE,NK,HR & Finance Assistant,HR & Finance Assistant,,,Permanent,0,63,Stephanie Dunstan,1.0,Environment,0%,0%,0%,0%,0%,0%,0%,100%,0%,,100%,,X,,,,,,,,,,,,,,,X,X
26,Iraia,Monteagudo,TRUE,female,Iraia Monteagudo,Startup Programme Assistant,,,Fixed-term,0,68,Ulrich Atz,1.0,Startups,0%,0%,100%,0%,0%,0%,0%,0%,0%,,100%,,,,,X,,,,,,,,,,,,X,
27,Irina,Bolychevsky,TRUE,female,Irina Bolychevsky,Open Data Certificate Community Builder,,,Contract,0,30,James Smith,0.4,Labs,0%,0%,0%,0%,0%,100%,0%,0%,0%,,100%,,,,,,,,,,,,X,,,,,,
28,Jack,Hardinges,TRUE,male,Jack Hardinges,Commercial Writer,,,Associate,0,67,Tom Tharakan,1.0,Services,0%,0%,0%,40%,10%,35%,15%,0%,0%,,100%,,,X,,,,,X,,,,,,,,,,
29,Jade,Croucher,TRUE,female,Jade Croucher,Operations Manager,,,Permanent,3,22,Gavin Starks,1.0,Environment,0%,0%,0%,0%,0%,0%,0%,100%,0%,,100%,X,,,,,,,,,,,,,,,,X,X
30,James,Smith,TRUE,male,James Smith,Head of Labs,,,Permanent,2,32,Jeni Tennison,1.0,Labs,0%,0%,0%,0%,0%,95%,0%,0%,5%,,100%,X,,,,X,,,,,,,,X,,,,,
31,Jamie,Fawcett,TRUE,male,Jamie Fawcett,Research Assistant,,,Permanent,0,15,Ellen Broad,1.0,Evidence,0%,10%,0%,0%,80%,10%,0%,0%,0%,,100%,,,,,,,,,,X,,,,,,,,
32,Jeni,Tennison,TRUE,female,Jeni Tennison,Deputy CEO & Technical Director,,,Permanent,6,22,Gavin Starks,1.0,Strategy,0%,0%,0%,15%,30%,10%,45%,0%,0%,,100%,X,,,,,,,,X,X,,,X,,,,,
33,Julie,Freeman,TRUE,female,Julie Freeman,Art Programme,,,Associate,0,37,Laura Davis,0.1,Culture,0%,0%,0%,0%,0%,0%,0%,0%,100%,,100%,,,,,,,X,,,,,,,,,,,
34,Julie,McMahon,TRUE,female,Julie McMahon,Global Network Programme Support,,,Permanent,0,52,Rachel Leech,1.0,Membership,40%,30%,30%,,0%,0%,0%,0%,0%,,100%,,,,,,,,,,,,,,,,,X,
35,NK,NK,FALSE,NK,Junior Designer,Junior Designer,,,Fixed-term,0,37,Laura Davis,1.0,Culture,0%,0%,0%,,0%,0%,0%,0%,100%,,100%,,,,,,,,,,,,,,,X,,,
36,Kateryna,Onyiliogwu,TRUE,female,Kateryna Onyiliogwu,Internation Development Network Lead,,,Fixed-term,0,21,Fiona Smith,1.0,Services,0%,0%,0%,100%,0%,0%,0%,0%,0%,,100%,,,,,X,X,,,,,,,,,,,,
37,Laura,Davis,TRUE,female,Laura Davis,Head of Content,,,Permanent,8,22,Gavin Starks,1.0,Culture,0%,0%,0%,0%,0%,0%,0%,0%,100%,,100%,X,,,,,,,,,,,,,,X,,,
38,Laura,Koesten,TRUE,female,Laura Koesten,PhD Student,,,Fixed-term,0,66,Tom Heath,1.0,Labs,0%,0%,0%,0%,0%,100%,0%,0%,0%,,100%,,,,,,,,,,X,,,X,,,,,
39,Leigh,Dodds,TRUE,male,Leigh Dodds,Senior Technical Consultant,,,Permanent,0,55,Richard Stirling,1.0,Services,0%,0%,0%,90%,0%,10%,0%,0%,0%,,100%,,,,,,,,X,,,,,,,,,,
40,Lewis,Kille,TRUE,male,Lewis Kille,Business Support Administrator,,,Fixed-term,0,29,Jade Croucher,1.0,Environment,0%,0%,0%,0%,0%,0%,0%,100%,0%,,100%,,,,,,,,,,,,,,,,,X,
41,Liz,Carolan,TRUE,female,Liz Carolan,International Development Associate,,,Associate,0,21,Fiona Smith,0.3,Services,0%,0%,0%,100%,0%,0%,0%,0%,0%,,100%,,,X,,,,,X,,,,,,,,,,
42,Louise,Burke,TRUE,female,Louise Burke,Finance & Compliance Director,,,Permanent,4,22,Gavin Starks,1.0,Strategy,5%,5%,5%,5%,5%,5%,60%,5%,5%,,100%,X,X,,,,,,,,,,,,,,,,
43,Mandy,Costello,TRUE,female,Mandy Costello,Training Projects and Delivery Manager,,,Fixed-term,2,60,Simon Bullmore,1.0,Learning,0%,100%,0%,0%,0%,0%,0%,0%,0%,,100%,,,,,,,X,,,,,,,,,,,
44,Martha,Lane-Fox,TRUE,female,Martha Lane-Fox,Non-Executive Director,,,Permanent,0,47,Nigel Shadbolt,0.0,Board,0%,0%,0%,0%,0%,0%,0%,0%,0%,100%,100%,X,,,,,,,,,,,,,,,,,
45,Martin,Tisne,TRUE,male,Martin Tisne,Non-Executive Director,,,Permanent,0,47,Nigel Shadbolt,0.0,Board,0%,0%,0%,0%,0%,0%,0%,0%,0%,100%,100%,X,,,,,,,,,,,,,,,,,
46,Neelie,Kroes,TRUE,female,Neelie Kroes,Non-Executive Director,,,Permanent,0,47,Nigel Shadbolt,0.0,Board,0%,0%,0%,0%,0%,0%,0%,0%,0%,100%,100%,X,,,,,,,,,,,,,,,,,
47,Nigel,Shadbolt,TRUE,male,Nigel Shadbolt,Chairman,,,Permanent,8,,,0.4,Board,0%,0%,0%,0%,0%,0%,50%,0%,0%,50%,100%,X,,X,,,,,,,,,,,,,,,
48,Orsola,DeMarco,TRUE,female,Orsola DeMarco,Startup Programme Assistant,,,Permanent,0,68,Ulrich Atz,1.0,Startups,0%,0%,100%,0%,0%,0%,0%,0%,0%,,100%,,,,,X,,,,,,,,,,,,X,
49,Patrice,John-Baptiste,TRUE,female,Patrice John-Baptiste,Communications,,,Fixed-term,0,19,Emma Thwaites,1.0,Evidence,5%,5%,10%,10%,30%,10%,10%,0%,20%,,100%,,,,,,,,,,,,,,X,,,,
50,Peter,Wells,TRUE,male,Peter Wells,Policy Advisor,,,Fixed-term,0,15,Ellen Broad,0.6,Strategy,0%,0%,0%,0%,0%,0%,100%,0%,0%,,100%,,,,,,,,,X,,,,,,,,,
51,Phil,Lang,TRUE,male,Phil Lang,Digital Production Editor,,,Permanent,0,37,Laura Davis,1.0,Culture,0%,5%,0%,5%,15%,5%,5%,0%,65%,,100%,,,,,,,,,,,,,,,X,,,
52,Rachel,Leech,TRUE,female,Rachel Leech,Membership Business Manager,,,Permanent,2,22,Gavin Starks,1.0,Membership,100%,0%,0%,0%,0%,0%,0%,0%,0%,,100%,X,,X,,X,,,,,,,,,,,,,
53,Richard,Marsh,TRUE,male,Richard Marsh,Non-Executive Director,,,Permanent,0,47,Nigel Shadbolt,0.0,Board,0%,0%,0%,0%,0%,0%,0%,0%,0%,100%,100%,X,,,,,,,,,,,,,,,,,
54,Richard,Norris,TRUE,male,Richard Norris,Innovation Unit Project Manager,,,Permanent,0,32,Jeni Tennison,1.0,Labs,0%,0%,0%,0%,30%,70%,0%,0%,0%,,100%,,,,,,,X,,,,,,,,,,,
55,Richard,Stirling,TRUE,male,Richard Stirling,International Director,,,Permanent,5,22,Gavin Starks,1.0,Strategy,0%,0%,0%,50%,0%,0%,50%,0%,0%,,100%,X,,X,,,,,,X,,,,,,,,,
56,Rob,Bryan,TRUE,male,Rob Bryan,Secretary,,,Permanent,0,47,Nigel Shadbolt,0.0,Board,0%,0%,0%,0%,0%,0%,0%,0%,0%,100%,100%,X,,,,,,,,,,,,,,,,,
57,Roger,Hampson,TRUE,male,Roger Hampson,Non-Executive Director,,,Permanent,0,47,Nigel Shadbolt,0.0,Board,0%,0%,0%,0%,0%,0%,0%,0%,0%,100%,100%,X,,,,,,,,,,,,,,,,,
58,Sam,Haines,TRUE,female,Sam Haines,Training Projects and Delivery Manager,,,Permanent,0,60,Simon Bullmore,1.0,Learning,0%,100%,0%,0%,0%,,0%,0%,0%,,100%,,,,,,,X,,,,,,,,,,,
59,Sam,Pikesley,TRUE,male,Sam Pikesley,Head of Robots,,,Permanent,0,32,Jeni Tennison,1.0,Labs,0%,0%,0%,0%,0%,100%,0%,0%,0%,,100%,,,,,,,,,,,,,X,,,,,
60,Simon,Bullmore,TRUE,male,Simon Bullmore,Head of Learning,,,Permanent,4,22,Gavin Starks,1.0,Learning,0%,100%,0%,0%,0%,0%,0%,0%,0%,,100%,X,,X,,,,,,,,,,,,,,,
61,Simone,Giles,TRUE,female,Simone Giles,PeopleDev,,,Permanent,0,42,Louise Burke,1.0,Environment,0%,0%,0%,0%,0%,0%,0%,100%,0%,,100%,X,,,,,,,,,,,,,,,,,X
62,Steff,Warwick,TRUE,female,Steff Warwick,Training Coordinator,,,Permanent,0,43,Mandy Costello,1.0,Learning,0%,100%,0%,0%,0%,0%,0%,0%,0%,,100%,,,,,,,X,,,,,,,,,,X,
63,Stephanie,Dunstan,TRUE,female,Stephanie Dunstan,Accounts Assistant,,,Permanent,1,42,Louise Burke,1.0,Environment,20%,5%,5%,5%,0%,5%,0%,50%,10%,,100%,,X,,,,,,,,,,,,,,,,
64,Stuart,Harrison,TRUE,male,Stuart Harrison,Developer,,,Permanent,0,32,Jeni Tennison,1.0,Labs,10%,10%,0%,0%,0%,65%,5%,0%,10%,,100%,,,,,,,,,,,,,X,,,,,
65,Tim,Berners-Lee,TRUE,male,Tim Berners-Lee,President,,,Permanent,0,47,Nigel Shadbolt,0.0,Board,0%,0%,0%,0%,0%,0%,0%,0%,0%,100%,100%,X,,,,,,,,,,,,,,,,,
66,Tom,Heath,TRUE,male,Tom Heath,Head of Research,,,Permanent,2,32,Jeni Tennison,0.8,Labs,0%,0%,0%,0%,10%,90%,0%,0%,0%,,100%,,,X,,X,,,,,X,,,X,,,,,
67,Tom,Tharakan,TRUE,male,Tom Tharakan,Bid Manager,,,Permanent,1,55,Richard Stirling,1.0,Services,5%,10%,5%,30%,10%,25%,15%,0%,0%,,100%,,,X,,,,,,,,,,,,,,,
68,Ulrich,Atz,TRUE,male,Ulrich Atz,Startup Programme Manager,17Dnf1RDEon_iqpC4qW8jgn77cw1fJLqAdeLNTZpp8Ko,https://docs.google.com/spreadsheets/d/17Dnf1RDEon_iqpC4qW8jgn77cw1fJLqAdeLNTZpp8Ko/edit,Permanent,2,55,Richard Stirling,1.0,Startups,0%,0%,100%,0%,0%,0%,0%,0%,0%,,100%,,,,,X,X,X,,,,,,,,,,,
69,William,Gerry,TRUE,male,William Gerry,Junior Consultant,,,Fixed-term,0,20,Emma Truswell,1.0,Services,0%,0%,0%,100%,0%,0%,0%,0%,0%,,100%,,,,,,,,X,,,,,,,,,X,</script>
<script>

var programmes = ["Membership", "Learning", "Startups", "Services", "Evidence", "Labs", "Strategy", "Environment", "Culture", "Board"];
var functions = ["leadership", "finance", "sales", "marketing", "engagement", "account mgmt", "project mgmt", "consultancy", "policy", "research", "training", "product mgmt", "software", "communications", "production", "events", "team support", "people dev"];

var diameter = 960,
    radius = diameter / 2,
    innerRadius = radius / 2;

var width = 960,
    height = 500;

var nodeRadius = 8;

var cluster = d3.layout.cluster()
    .size([360, radius - 120]);

var tree = d3.layout.tree()
    .size([360, diameter / 2 - 120])
    .separation(function(a, b) { return (a.parent == b.parent ? 1 : 2) / a.depth; });

var diagonal = d3.svg.diagonal.radial()
    .projection(function(d) { return [d.y, d.x / 180 * Math.PI]; });

var color = d3.scale.ordinal()
    .domain(programmes)
    .range(["#0DBC37", "#1DD3A7", "#08DEF9", "#722EA5", "#B13198", "#EF3AAB", "#D60303", "#FF6700", "#F9BC26", "#CCCCCC"]);

var arc = d3.svg.arc()
    .outerRadius(nodeRadius)
    .innerRadius(function (d) { return (d.data.type !== "person" || d.data.inPost) ? 0 : 5 });

var pie = d3.layout.pie()
    .sort(null)
    .value(function(d) { return d.size; });

var chord = d3.layout.chord()
    .padding(.04)
    .sortSubgroups(d3.ascending)
    .sortChords(d3.ascending);

var chordArc = d3.svg.arc()
    .innerRadius(innerRadius)
    .outerRadius(innerRadius + 20);

var svg = d3.select("#line-management")
    .attr("width", radius * 2)
    .attr("height", radius * 2)
  .append("g")
    .attr("transform", "translate(" + radius + "," + radius + ")");

var svg2 = d3.select("#programmes")
    .attr("width", width)
    .attr("height", height);

var svg3 = d3.select("#functions")
    .attr("width", width)
    .attr("height", height);

var svg4 = d3.select("#chord")
    .attr("width", radius * 2)
    .attr("height", radius * 2)
  .append("g")
    .attr("transform", "translate(" + radius + "," + radius + ")");

d3.select("tr").selectAll("td")
    .data(programmes)
  .enter().append("td")
    .attr("style", function (d) { return "background: " + color(d) + "; width: 11%"; })
    .text(function(d) { return d; });


var peopleLookup = {};
var parentLookup = {};
var matrix = [];
var peopleRootId;

var nameByIndex = d3.map();
var typeByIndex = d3.map();
var indexByName = d3.map();
var n = 0;

var programmeRegex = new RegExp(programmes.join('|'));
var functionRegex = new RegExp(functions.join('|'));

var programmeLookup = {};
for (p in programmes) {
  nameByIndex.set(n, programmes[p]);
  typeByIndex.set(n, "programme");
  indexByName.set(programmes[p], n);
  matrix[n] = [];
  n++;
  programmeLookup[programmes[p]] = [];
}
var functionLookup = {};
for (f in functions) {
  nameByIndex.set(n, functions[f]);
  typeByIndex.set(n, "function");
  indexByName.set(functions[f], n);
  matrix[n] = [];
  n++;
  functionLookup[functions[f]] = [];
}

d3.csv.parse(document.getElementById('people').firstChild.nodeValue, function (d) {
  var person = {
    type: "person",
    id: +d["Member Id"],
    name: d["Name"],
    inPost: d["In Post"] == "TRUE",
    roleTitle: d["Role Title"],
    parent: +d["Reports To ID"],
    programmes: [],
    functions: []
  };
  var m;
  nameByIndex.set(n, person.name);
  typeByIndex.set(n, "person");
  indexByName.set(person.name, n);
  matrix[n] = [];
  n++;
  for (var col in d) {
    if (d[col] == "X" || (d[col] !== "" && d[col] !== "0%")) {
      if (m = col.match(programmeRegex)) {
        person.programmes.push(m[0]);
        programmeLookup[m[0]].push(person.id);
      } else if (m = col.match(functionRegex)) {
        person.functions.push(m[0]);
        functionLookup[m[0]].push(person.id);
      }
      if (m) {
        matrix[indexByName.get(m[0])][indexByName.get(person.name)] = 5;
        matrix[indexByName.get(person.name)][indexByName.get(m[0])] = 1;
      }
    }
  }
  peopleLookup[person.id] = person;
  if (parentLookup[person.parent] == undefined) {
    parentLookup[person.parent] = [];
  }
  parentLookup[person.parent].push(person.id);
  if (person.parent == 0) {
    peopleRootId = person.id;
  }
  return;
});

for (var i = 0; i < n; i++) {
  for (var j = 0; j < n; j++) {
    if (matrix[i][j] === undefined) matrix[i][j] = 0;
  }
}

var createHierarchy = function (id) {
  var 
    person = peopleLookup[id],
    p = { 
      type: "person",
      name: person.name, 
      inPost: person.inPost,
      roleTitle: person.roleTitle,
      programmes: person.programmes
    },
    children = parentLookup[id];
  if (children !== undefined) {
    p.children = [];
    for (var i = 0; i < children.length; i++) {
      p.children.push(createHierarchy(children[i]));
    }
  }
  return p;
};

var createProgrammeGraph = function () {
  var graph = {
    nodes: [],
    links: []
  };
  for (p in peopleLookup) {
    var person = peopleLookup[p];
    graph.nodes[person.id - 1] = person;
  }
  programmes.forEach(function (programme) {
    graph.nodes.push({ name: programme, type: "programme" });
    programmeLookup[programme].forEach(function (id) {
      graph.links.push({
        source: graph.nodes.length - 1,
        target: id - 1
      });
    });
  });
  return graph;
};

var createFunctionGraph = function () {
  var graph = {
    nodes: [],
    links: []
  };
  for (p in peopleLookup) {
    var person = peopleLookup[p];
    graph.nodes[person.id - 1] = person;
  }
  functions.map(function (func) {
    graph.nodes.push({ name: func, type: "function" });
    functionLookup[func].map(function (id) {
      graph.links.push({
        source: graph.nodes.length - 1,
        target: id - 1
      });
    });
  });
  return graph;
};

var drawNode = function(node) {
  node.append("circle")
    .style("stroke-width", function (d) { return d.type == "person" ? 0 : 5 })
    .style("stroke", "black")
    .style("fill", "#ffffff")
    .attr("r", nodeRadius);

  var g = node.selectAll(".arc")
      .data(function (d) { 
        if (d.programmes) {
          return pie(d.programmes.map(function (p) { return { name: p, size: 1, type: "person", inPost: d.inPost }; })); 
        } else {
          return pie([{name: d.name, size: 1, type: d.type}]);
        }
      })
    .enter().append("g")
      .attr("class", "arc");

  g.append("path")
      .attr("d", arc)
      .style("fill", function(d) { 
        if (d.data.type == "function") {
          return "#999999";
        } else {
          return color(d.data.name);
        }
      });
};

var drawLineMgmt = function (root) {
  // uncomment to get all the leaf nodes at the same level
  // var nodes = cluster.nodes(root);
  // var links = cluster.links(nodes);

  // leaf nodes at different levels
  var nodes = tree.nodes(root);
  var links = tree.links(nodes);

  var link = svg.selectAll("path.link")
      .data(links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", diagonal);

  var node = svg.selectAll("g.node")
      .data(nodes)
    .enter().append("g")
      .attr("class", function (d) { return "node"; })
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + d.y + ")"; })

  drawNode(node);

  node.append("title")
      .text(function(d) { return d.roleTitle; });

  node.append("text")
      .attr("dy", ".31em")
      .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      .attr("transform", function(d) { return d.x < 180 ? "translate(10)" : "rotate(180)translate(-10)"; })
      .text(function(d) { return d.name; });

  d3.select(self.frameElement).style("height", radius * 2 + "px");
};

drawLineMgmt(createHierarchy(peopleRootId));

var drawChord = function (matrix, svg) {
  var chordColor = function(i) {
    var type = typeByIndex.get(i);
    if (type === "programme") {
      return color(nameByIndex.get(i));
    } else if (type === "function") {
      return "#666666";
    } else {
      return "#AAAAAA";
    }
  };

  chord.matrix(matrix);

  var g = svg.selectAll(".group")
      .data(chord.groups)
    .enter().append("g")
      .attr("class", "group")
      .on("mouseover", mouseover);

  g.append("path")
      .style("fill", function(d) { return chordColor(d.index); })
      .style("stroke", function(d) { return chordColor(d.index); })
      .attr("d", chordArc);

  g.append("text")
      .each(function(d) { d.angle = (d.startAngle + d.endAngle) / 2; })
      .attr("dy", ".35em")
      .attr("transform", function(d) {
        return "rotate(" + (d.angle * 180 / Math.PI - 90) + ")"
            + "translate(" + (innerRadius + 26) + ")"
            + (d.angle > Math.PI ? "rotate(180)" : "");
      })
      .style("text-anchor", function(d) { return d.angle > Math.PI ? "end" : null; })
      .text(function(d) { return nameByIndex.get(d.index); });

  var chords = svg.selectAll(".chord")
      .data(chord.chords)
    .enter().append("path")
      .attr("class", "chord")
      .style("stroke", function(d) { return "none" ; })
      .style("fill", function(d) { return chordColor(d.source.index); })
      .attr("d", d3.svg.chord().radius(innerRadius));

  d3.select(self.frameElement)
    .style("height", radius * 2 + "px");

  svg
    .on("click", showAll);

  function mouseover(d, i) {
    chords.classed("fade", function(p) {
      return p.source.index != i
          && p.target.index != i;
    });
  }

  function showAll() {
    chords.classed("fade", false);
  }
};

drawChord(matrix, svg4);

var drawGraph = function (graph, svg) {
  var nodes = graph.nodes.slice(),
      links = [],
      bilinks = [];

  var force = d3.layout.force()
      .linkDistance(10)
      .linkStrength(2)
      .size([width, height]);

  graph.links.forEach(function(link) {
    var s = nodes[link.source],
        t = nodes[link.target],
        i = {}; // intermediate node
    nodes.push(i);
    links.push({source: s, target: i}, {source: i, target: t});
    bilinks.push([s, i, t]);
  });

  force
      .nodes(nodes)
      .links(links)
      .start();

  var link = svg.selectAll(".link")
      .data(bilinks)
    .enter().append("path")
      .attr("class", "link");

  var node = svg.selectAll(".node")
      .data(graph.nodes)
    .enter().append("g")
      .attr("class", function (d) { return "node"; })
      .call(force.drag);

  drawNode(node);

  node.append("title")
      .text(function(d) { return d.name; });

  node.append("text")
      .style("font-size", "8px")
      .style("font-weight", "bold")
      .style("fill", function (d) { return d.inPost ? "white" : "#999999"; } )
      .attr("dy", ".31em")
      .attr("dx", "-.62em")
      // .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      // .attr("transform", function(d) { return d.x < 180 ? "translate(10)" : "rotate(180)translate(-10)"; })
      .text(function(d) { return (d.type == "person" && d.name !== d.roleTitle) ? d.name.match(/[A-Z]/g).join('') : ''; });

  force.on("tick", function() {
    link.attr("d", function(d) {
      return "M" + d[0].x + "," + d[0].y
          + "S" + d[1].x + "," + d[1].y
          + " " + d[2].x + "," + d[2].y;
    });
    node.attr("transform", function(d) {
      return "translate(" + d.x + "," + d.y + ")";
    });
  });
};

drawGraph(createProgrammeGraph(), svg2);
drawGraph(createFunctionGraph(), svg3);

</script>
